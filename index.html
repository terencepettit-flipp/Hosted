<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Flipp Storefront Host</title>

    <!-- Flipp SDK -->
    <script
      src="https://aq.flippenterprise.net/6737/iframe.js"
      id="flipp-storefront-script"
    ></script>

    <style>
      :root {
        --bg: #0b0f17;
        --panel: rgba(255, 255, 255, 0.07);
        --panel2: rgba(255, 255, 255, 0.05);
        --text: rgba(255, 255, 255, 0.92);
        --muted: rgba(255, 255, 255, 0.68);
        --border: rgba(255, 255, 255, 0.12);
        --shadow: 0 20px 60px rgba(0, 0, 0, 0.45);
        --radius: 18px;
      }

      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji",
          "Segoe UI Emoji";
        color: var(--text);
        background: radial-gradient(1200px 600px at 20% 0%, rgba(104, 156, 255, 0.12), transparent 50%),
          radial-gradient(1000px 700px at 90% 20%, rgba(255, 126, 179, 0.10), transparent 55%),
          var(--bg);
      }

      .wrap {
        max-width: 1100px;
        margin: 0 auto;
        padding: 18px;
      }

      details.controls {
        background: linear-gradient(180deg, var(--panel), var(--panel2));
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        overflow: clip;
      }

      summary {
        list-style: none;
        cursor: pointer;
        padding: 14px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        user-select: none;
      }
      summary::-webkit-details-marker { display: none; }

      .summary-left {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }
      .title {
        font-size: 14px;
        letter-spacing: 0.2px;
        font-weight: 700;
      }
      .subtitle {
        font-size: 12px;
        color: var(--muted);
      }

      .chev {
        width: 36px;
        height: 36px;
        border-radius: 12px;
        border: 1px solid var(--border);
        display: grid;
        place-items: center;
        background: rgba(255,255,255,0.04);
        transition: transform 180ms ease;

        transform: rotate(180deg); /* default */
      }

      details[open] .chev {
        transform: rotate(0deg); /* when expanded */
      }

      .controls-body {
        padding: 0 16px 16px 16px;
        border-top: 1px solid rgba(255, 255, 255, 0.08);
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 12px;
        margin-top: 14px;
      }

      .field {
        grid-column: span 4;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .field.wide { grid-column: span 12; }

      label {
        font-size: 12px;
        color: var(--muted);
      }

      input {
        width: 100%;
        padding: 12px 12px;
        border-radius: 14px;
        border: 1px solid var(--border);
        background: rgba(0, 0, 0, 0.18);
        color: var(--text);
        outline: none;
      }
      input:focus {
        border-color: rgba(104, 156, 255, 0.55);
        box-shadow: 0 0 0 4px rgba(104, 156, 255, 0.16);
      }

      /* Select styling to match inputs */
      select {
        width: 100%;
        padding: 12px 12px;
        border-radius: 14px;
        border: 1px solid var(--border);
        background: rgba(0, 0, 0, 0.18);
        color: var(--text);
        outline: none;
        appearance: none;
      }
      select:focus {
        border-color: rgba(104, 156, 255, 0.55);
        box-shadow: 0 0 0 4px rgba(104, 156, 255, 0.16);
      }

      .actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
        margin-top: 12px;
      }

      button {
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.08);
        color: var(--text);
        border-radius: 14px;
        padding: 10px 14px;
        cursor: pointer;
        font-weight: 650;
      }
      button.primary {
        background: linear-gradient(180deg, rgba(104,156,255,0.35), rgba(104,156,255,0.18));
        border-color: rgba(104,156,255,0.55);
      }
      button:active { transform: translateY(1px); }

      .hint {
        font-size: 12px;
        color: var(--muted);
      }

      .main {
        margin-top: 14px;
        background: linear-gradient(180deg, var(--panel), var(--panel2));
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        overflow: clip;
      }

      .main-header {
        padding: 14px 16px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        display: flex;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
      }

      .status {
        font-size: 12px;
        color: var(--muted);
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.25);
      }
      .dot.ok { background: rgba(88, 255, 170, 0.7); }
      .dot.err { background: rgba(255, 110, 110, 0.8); }

      .main-body { padding: 12px; }

      #flipp-container {
        min-height: 70vh;
        background: rgba(0, 0, 0, 0.12);
        border: 1px dashed rgba(255,255,255,0.14);
        border-radius: 16px;
        padding: 10px;
      }

      @media (max-width: 900px) {
        .field { grid-column: span 12; }
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <!-- 1) Retractable controls -->
      <details class="controls" open>
        <summary>
          <div class="summary-left">
            <div class="title">Parameters</div>
            <div class="subtitle">Select a merchant or enter values, then click Render</div>
          </div>
          <div class="chev" aria-hidden="true">⌃</div>
        </summary>

        <div class="controls-body">
          <!-- Merchant dropdown + helper text -->
          <div class="grid">
            <div class="field wide">
              <label for="merchantPreset">Select a merchant:</label>
              <select id="merchantPreset">
                <option value="">— Select —</option>
                <option value="toysrus_ca">Toys R Us Canada</option>
                <option value="bmr">BMR</option>
              </select>
            </div>

            <div class="field wide">
              <div class="hint" style="margin-top: 4px;">Or enter parameters manually:</div>
            </div>

            <div class="field">
              <label for="merchantId">Merchant ID</label>
              <input id="merchantId" inputmode="numeric" placeholder="e.g. 6737" />
            </div>

            <div class="field">
              <label for="merchantNameIdentifier">Merchant name identifier</label>
              <input id="merchantNameIdentifier" placeholder="e.g. liquormart" />
            </div>

            <div class="field">
              <label for="accessToken">Access token</label>
              <input id="accessToken" placeholder="e.g. f2a3a3d8..." />
            </div>
          </div>

          <div class="actions">
            <button class="primary" id="renderBtn">Render</button>
            <button id="copyLinkBtn" type="button">Copy link with params</button>
            <span class="hint" id="hint"></span>
          </div>
        </div>
      </details>

      <!-- 2) Main display section -->
      <section class="main" aria-label="Storefront">
        <div class="main-header">
          <div>
            <div class="title">Storefront</div>
            <div class="subtitle">Renders into the container below</div>
          </div>
          <div class="status" id="status">
            <span class="dot" id="dot"></span>
            <span id="statusText">Idle</span>
          </div>
        </div>

        <div class="main-body">
          <div id="flipp-container"></div>
        </div>
      </section>
    </div>

    <script>
      // ---------- Helpers ----------
      function setStatus(kind, text) {
        const dot = document.getElementById("dot");
        const statusText = document.getElementById("statusText");
        dot.classList.remove("ok", "err");
        if (kind === "ok") dot.classList.add("ok");
        if (kind === "err") dot.classList.add("err");
        statusText.textContent = text;
      }

      function getQueryParam(param, defaultValue) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param) || defaultValue;
      }

      function setQueryParams({ accessToken, merchantId, merchantNameIdentifier }) {
        const url = new URL(window.location.href);
        url.searchParams.set("accessToken", accessToken);
        url.searchParams.set("merchantId", merchantId);
        url.searchParams.set("merchantNameIdentifier", merchantNameIdentifier);
        history.replaceState({}, "", url.toString());
        return url.toString();
      }

      function waitForFlippSDK({ timeoutMs = 8000, pollMs = 50 } = {}) {
        const started = Date.now();
        return new Promise((resolve, reject) => {
          const t = setInterval(() => {
            const ok = window.Flipp && window.Flipp.Storefront;
            if (ok) {
              clearInterval(t);
              resolve();
              return;
            }
            if (Date.now() - started > timeoutMs) {
              clearInterval(t);
              reject(new Error("Flipp SDK not available (timed out)"));
            }
          }, pollMs);
        });
      }

      function resetFlippContainer() {
        const old = document.getElementById("flipp-container");
        const fresh = document.createElement("div");
        fresh.id = "flipp-container";
        // Keep the same styling as before by reusing the id selector
        old.replaceWith(fresh);
        return fresh;
      }

      // ---------- Presets (easy to extend) ----------
      // Add a new entry here AND add a matching <option value="key">Name</option> above.
      const MERCHANT_PRESETS = {
        toysrus_ca: {
          label: "Toys R Us Canada",
          merchantId: "246",
          merchantNameIdentifier: "toysruscanada",
          accessToken: "1ddfda9d56236c47ae8fbcd9f508ced1",
        },
        bmr: {
          label: "BMR",
          merchantId: "2157",
          merchantNameIdentifier: "bmr",
          accessToken: "94eb9935d1ff4e401784072522d789a3",
        },
      };

      function applyPreset(presetKey) {
        const preset = MERCHANT_PRESETS[presetKey];
        if (!preset) return;
        document.getElementById("merchantId").value = preset.merchantId;
        document.getElementById("merchantNameIdentifier").value = preset.merchantNameIdentifier;
        document.getElementById("accessToken").value = preset.accessToken;
      }

      // ---------- Your delegates ----------
      function getCustomElements(item) {
        console.log("customElements Item clicked on: ", item.sku);
        return {
          slot2: [
            {
              type: "img",
              text: "SLOT 2 IMAGE",
              src: "https://i.pinimg.com/originals/1b/5a/37/1b5a37783780aab6c07419713334a537.gif",
            },
          ],
        };
      }

      function getMerchantCartOptions(items, storeCode) {
        const cartOptionsArray = [];
        items.forEach((i) => {
          cartOptionsArray.push(getMerchantCartOptionForItem(i.sku, storeCode));
        });
        return cartOptionsArray;
      }

      function getMerchantCartOptionForItem(itemSku, storeCode) {
        return [
          {
            id: "1234",
            cartabilityType: 1,
            label: {
              "en-US": "Add To Cart",
              "en-CA": "Add To Cart",
              "fr-CA": "Ajouter au panier",
            },
          },
        ];
      }

      function addToMerchantCart(item, cartOption) {
        console.log("Item ", item, " was added with the option ", cartOption);
        return true;
      }

      function getCurrentQuantityLogger(item, storeCode) {
        const quantity = 3;
        console.log("Item ", item, " checked for existing quantity");
        return quantity;
      }

      // ---------- Rendering ----------
      async function renderStorefrontFromInputs() {
        const merchantIdEl = document.getElementById("merchantId");
        const merchantNameIdentifierEl = document.getElementById("merchantNameIdentifier");
        const accessTokenEl = document.getElementById("accessToken");
        const hint = document.getElementById("hint");

        const merchantId = merchantIdEl.value.trim();
        const merchantNameIdentifier = merchantNameIdentifierEl.value.trim();
        const accessToken = accessTokenEl.value.trim();

        hint.textContent = "";

        if (!merchantId || !merchantNameIdentifier || !accessToken) {
          setStatus("err", "Missing required inputs");
          hint.textContent = "Fill all three fields (or pick a preset).";
          return;
        }

        // Push values into the URL (so the query-string pattern applies)
        const shareUrl = setQueryParams({ accessToken, merchantId, merchantNameIdentifier });

        setStatus("", "Loading SDK…");
        try {
          await waitForFlippSDK();
        } catch (e) {
          console.error(e);
          setStatus("err", "SDK not available");
          hint.textContent = "Check the iframe.js URL and network access.";
          return;
        }

        setStatus("", "Rendering…");

        const flippContainer = resetFlippContainer();

        try {
          const storefront = new Flipp.Storefront({
            accessToken: getQueryParam("accessToken", accessToken),
            merchantId: getQueryParam("merchantId", merchantId),
            merchantNameIdentifier: getQueryParam("merchantNameIdentifier", merchantNameIdentifier),

            cartDelegate: {
              getCartOptions: getMerchantCartOptions,
              addToCart: addToMerchantCart,
              getCurrentQuantity: getCurrentQuantityLogger,
            },
            itemDetailsDelegate: {
              getCustomElements: getCustomElements,
            },
          });

          storefront.setDelegate("cartDelegate", {
            getCartOptions: getMerchantCartOptions,
            addToCart: addToMerchantCart,
          });

          storefront.setDelegate("itemDetailsDelegate", {
            getCustomElements: getCustomElements,
          });

          storefront.renderStorefront(flippContainer);

          setStatus("ok", "Rendered");
          hint.textContent = "URL updated with current params.";
          // eslint-disable-next-line no-unused-vars
          void shareUrl;
        } catch (e) {
          console.error(e);
          setStatus("err", "Render failed");
          hint.textContent = "Open DevTools console for details.";
        }
      }

      // ---------- Init ----------
      window.addEventListener("load", () => {
        const presetSelect = document.getElementById("merchantPreset");

        // 1) If all three query params exist, use them (shareable URLs).
        // 2) Otherwise, default to blank fields (user picks preset or types manually).
        const qpMerchantId = getQueryParam("merchantId", "");
        const qpMerchantNameIdentifier = getQueryParam("merchantNameIdentifier", "");
        const qpAccessToken = getQueryParam("accessToken", "");

        document.getElementById("merchantId").value = qpMerchantId;
        document.getElementById("merchantNameIdentifier").value = qpMerchantNameIdentifier;
        document.getElementById("accessToken").value = qpAccessToken;

        // Auto-select preset if query params exactly match one
        const matchKey = Object.keys(MERCHANT_PRESETS).find((k) => {
          const p = MERCHANT_PRESETS[k];
          return (
            p.merchantId === qpMerchantId &&
            p.merchantNameIdentifier === qpMerchantNameIdentifier &&
            p.accessToken === qpAccessToken
          );
        });
        if (matchKey) presetSelect.value = matchKey;

        // Changing preset fills inputs (does NOT auto-render; click Render)
        presetSelect.addEventListener("change", () => applyPreset(presetSelect.value));

        document.getElementById("renderBtn").addEventListener("click", renderStorefrontFromInputs);

        document.getElementById("copyLinkBtn").addEventListener("click", async () => {
          const accessToken = document.getElementById("accessToken").value.trim();
          const merchantId = document.getElementById("merchantId").value.trim();
          const merchantNameIdentifier = document.getElementById("merchantNameIdentifier").value.trim();
          const hint = document.getElementById("hint");

          if (!accessToken || !merchantId || !merchantNameIdentifier) {
            setStatus("err", "Missing required inputs");
            hint.textContent = "Fill all three fields first.";
            return;
          }

          const url = setQueryParams({ accessToken, merchantId, merchantNameIdentifier });
          try {
            await navigator.clipboard.writeText(url);
            setStatus("ok", "Link copied");
            hint.textContent = "Copied to clipboard.";
          } catch {
            setStatus("", "Copy failed");
            hint.textContent = url;
          }
        });

        // If query params are present, auto-render
        if (qpMerchantId && qpMerchantNameIdentifier && qpAccessToken) {
          renderStorefrontFromInputs();
        } else {
          setStatus("", "Idle");
        }
      });
    </script>
  </body>
</html>
